#!/usr/bin/env ruby
# frozen_string_literal: true

# Allow `require` calls relative to `lib`
$LOAD_PATH.unshift File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib'))

require 'dotenv/load'
require 'optimist'
require 'secret_santa/gift_exchange'
require 'secret_santa/mailer'
require 'secret_santa/stub_mailer'

opts = Optimist.options do
  opt :csv_path, 'Path to an input CSV', type: :string, required: true
  opt :redact, 'Redact generated assignments', type: :flag
  opt :dry_run, 'Generate assignments but do not actually send emails', type: :flag
end

mailer = if opts.dry_run
           SecretSanta::StubMailer.new
         else
           SecretSanta::Mailer.new(
             smtp_host: ENV.fetch('SMTP_HOST', nil),
             smtp_port: ENV.fetch('SMTP_PORT', nil),
             smtp_username: ENV.fetch('SMTP_USERNAME', nil),
             smtp_password: ENV.fetch('SMTP_PASSWORD', nil)
           )
           raise 'not ready yet'
         end

gift_exchange = SecretSanta::GiftExchange.new(
  redact_recipients: opts.redact,
  csv_path: opts.csv_path,
  mailer: mailer
)

gift_exchange.assign_and_notify
